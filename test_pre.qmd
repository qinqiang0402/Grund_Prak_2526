---
title: "Frauen, Kinder und Arbeit"
subtitle: "Grundlegendes Praxisprojekt"
author: "Qiang Qin, Shihan Hu, Yuechen Wang, Yuqin Huang"
institute: | 
  <br> Eugen Gorich <br><br>
  München
date: "2025-12-15"

format:
  revealjs:
    embed-resources: true
    slide-number: c
    logo: "images/LMU_Logo.svg"

css: customstyle.css
editor: visual
server: shiny
---

```{r}
#| label: setup
#| include: false

#source("env_setup.R")

# 加载你需要的包
library(shiny)
library(tidyverse)
library(readxl)
library(sf)
library(stringr)
library(forcats)
library(ggpubr)
library(leaflet)
library(htmltools)

# 把所有要用到的图从 RDS 里读进来
table_datenaufbau <- readRDS("results/figures/table/df_data.rds")
table_datenaufbau_01 <- readRDS("results/figures/table/df_data_qiang.rds")
leaflet_sv_durchschnitt <- readRDS("results/figures/SV/leaflet_sv_durchschnitt.rds")


#_________________________________________________________________________________________________________
hmk_korr_ponit_nach_stadtteile_color <- readRDS("results/figures/Haushalt_mit_Kindern/hmk_korr_ponit_nach_stadtteile_color.rds")
hmk_korr_point_line_nach_stadtteile_color <- readRDS("results/figures/Haushalt_mit_Kindern/hmk_korr_point_line_nach_stadtteile_color.rds")
hmk_simpson_stadtteile_kleiner_0 <- readRDS("results/figures/Haushalt_mit_Kindern/hmk_simpson_stadtteile_kleiner_0.rds")
hmk_korr_gesamt_point_sw <- readRDS("results/figures/Haushalt_mit_Kindern/hmk_korr_gesamt_point_sw.rds")
hmk_korr_point_nach_jahr_color <-  readRDS("results/figures/Haushalt_mit_Kindern/hmk_korr_point_nach_jahr_color.rds")
hmk_korr_point_line_nach_jahr_color <- readRDS("results/figures/Haushalt_mit_Kindern/hmk_korr_point_line_nach_jahr_color.rds")

#______________________________________________________________________________
ki_dual_trend <- readRDS("results/figures/Kinderbetreuung/ki_dual_trend.rds")
ki_map_2015 <- readRDS("results/figures/Kinderbetreuung/map_ki_2015.rds")
sv_map_2015 <- readRDS("results/figures/Kinderbetreuung/map_sv_2015.rds")
ki_point_korr_gesamt_sw <- readRDS("results/figures/Kinderbetreuung/ki_point_korr_gesamt_sw.rds")
ki_point_line_color <- readRDS("results/figures/Kinderbetreuung/ki_point_line_color.rds")
ki_simpson_sw <- readRDS("results/figures/Kinderbetreuung/ki_simpson_sw.rds")
ki_point_line_korr_nach_stadtteile_color <- readRDS("results/figures/Kinderbetreuung/ki_point_line_korr_nach_stadtteile_color.rds")

#__________________________________________________________________________
m_effekt_01 <- readRDS("results/figures/m_effekt/m_effekt_01_singleline.rds")
m_effekt_02 <- readRDS("results/figures/m_effekt/m_effekt_02_colored.rds")
m_effekt_2.5 <- readRDS("results/figures/m_effekt/m_effekt_2.5.rds")
m_effekt_03 <- readRDS("results/figures/m_effekt/m_effekt_03.rds")
m_effekt_04 <- readRDS("results/figures/m_effekt/m_effekt_04.rds")

#_____________________________________________________________________________
geburtenrate_dual_trend <- readRDS("results/figures/Geburtenrate/geburtenrate_dual_trend.rds")
geburtenrate_trend_nach_stadtteile <- readRDS("results/figures/Geburtenrate/geburtenrate_trend_nach_stadtteile.rds")
geburtenrate_korr_nach_stadtteile <- readRDS("results/figures/Geburtenrate/geburtenrate_korr_nach_stadtteile.rds")
geburtenrate_korr_trend_nach_jahr <- readRDS("results/figures/Geburtenrate/geburtenrate_korr_trend_nach_jahr.rds")

#_______________________________________________________________________________
mea_gesamt_sw <- readRDS("results/figures/MEA/mea_gesamt_sw.rds")
mea_korr_nach_stadtteilen_point <- readRDS("results/figures/MEA/mea_korr_nach_stadtteilen_point.rds")
mea_korr_nach_stadtteilen_point_line <- readRDS("results/figures/MEA/mea_korr_nach_stadtteilen_point_line.rds")
mea_korr_jahr_point <- readRDS("results/figures/MEA/mea_korr_jahr_point.rds")
mea_korr_jahr_point_line <- readRDS("results/figures/MEA/mea_korr_jahr_point_line.rds")
#________________________________________________________________________________




#_______________________________________________________________________________

# =================================================================
# Shiny 地图用的数据准备（von Shiny Skript übernommen）
# =================================================================

# 1. Geometrie der Münchner Stadtbezirke laden
munich_map <- st_read("results/geo/bezirk_map.json", quiet = TRUE) |> st_transform(4326)

# 2. Excel-Daten laden
# 注意：这里相对路径用项目根目录的写法，而不是 ../../
be_sheet <- read_excel("data/raw/export_be.xlsx", sheet = "BEVÖLKERUNG")
ar_sheet <- read_excel("data/raw/export_ar.xlsx", sheet = "ARBEITSMARKT")
ki_sheet <- read_excel("data/raw/export_ki.xlsx", sheet = "KINDERBETREUUNG") 

# 3. 各个指标（Variable）长表格式（long-format）

# 3.1 Durchschnittsalter Mütter erstgebärend
be_data_long <- be_sheet %>%
  filter(
    Indikator == "Durchschnittsalter Mütter erstgebärend", 
    Ausprägung == "insgesamt", 
    Raumbezug != "Stadt München"
  ) %>%
  mutate(
    age_mean = `Basiswert 1` / `Basiswert 2`,
    bezirksnummer = sprintf("%02d", as.numeric(str_extract(Raumbezug, "^\\d+")))
  ) %>%
  select(Jahr, bezirksnummer, age_mean) %>% 
  filter(!is.na(bezirksnummer))

# 3.2 Anteil Frauenbeschäftigung
ar_data_long <- ar_sheet %>%
  filter(
    Indikator == "Sozialversicherungspflichtig Beschäftigte - Anteil", 
    Ausprägung == "weiblich", 
    Raumbezug != "Stadt München"
  ) %>%
  mutate(
    anteil = 100 * `Basiswert 1` / `Basiswert 2`,
    bezirksnummer = sprintf("%02d", as.numeric(str_extract(Raumbezug, "^\\d+")))
  ) %>%
  select(Jahr, bezirksnummer, anteil) %>% 
  filter(!is.na(bezirksnummer))

# 3.3 Haushalte mit Kindern
hh_data_long <- be_sheet %>%
  filter(
    Indikator == "Haushalte mit Kindern", 
    Ausprägung == "insgesamt", 
    Raumbezug != "Stadt München"
  ) %>%
  mutate(
    anteil_kinder = 100 * `Basiswert 1` / `Basiswert 2`,
    bezirksnummer = sprintf("%02d", as.numeric(str_extract(Raumbezug, "^\\d+")))
  ) %>%
  select(Jahr, bezirksnummer, anteil_kinder) %>% 
  filter(!is.na(bezirksnummer))

# 3.4 Kinderbetreuungsquote 0–2 Jahre
# Schritt A: Nenner (Alle Kinder 0–2) aus BEVÖLKERUNG
df_total <- be_sheet %>%
  filter(
    Indikator == "Altersgruppen", 
    Ausprägung == "bis 2 Jahre", 
    Raumbezug != "Stadt München"
  ) %>%
  select(Jahr, Raumbezug, kinder_total = `Basiswert 1`)

# Schritt B: Zähler (Betreute Kinder) aus KINDERBETREUUNG
df_betreut_raw <- ki_sheet %>%
  filter(
    Indikator == "Altersgruppen", 
    Ausprägung == "bis 2 Jahre", 
    Raumbezug != "Stadt München"
  ) %>%
  select(Jahr, Raumbezug, kinder_betreut = `Basiswert 1`)

# Schritt C: Join + Quote
betreuung_data_long <- df_total %>%
  left_join(df_betreut_raw, by = c("Jahr", "Raumbezug")) %>%
  mutate(
    anteil_betreuung = 100 * kinder_betreut / kinder_total,
    bezirksnummer = sprintf("%02d", as.numeric(str_extract(Raumbezug, "^\\d+")))
  ) %>%
  select(Jahr, bezirksnummer, anteil_betreuung) %>%
  filter(!is.na(bezirksnummer))

# 3.5 Geburtenrate (wie im Shiny-Skript)
gr_data_long <- be_sheet %>%
  filter(
    Indikator == "Allgemeine Geburtenrate",
    Ausprägung == "insgesamt",
    Raumbezug != "Stadt München"
  ) %>%
  mutate(
    new_baby = 100 * `Basiswert 1` / `Basiswert 2`, 
    bezirksnummer = sprintf("%02d", as.numeric(str_extract(Raumbezug, "^\\d+")))
  ) %>%
  select(Jahr, bezirksnummer, new_baby) %>%
  filter(!is.na(bezirksnummer))

# 3.6 Alle Variablen zusammenmergen
combined_data_all <- be_data_long %>%
  full_join(ar_data_long,       by = c("Jahr", "bezirksnummer")) %>%
  full_join(hh_data_long,       by = c("Jahr", "bezirksnummer")) %>%
  full_join(betreuung_data_long,by = c("Jahr", "bezirksnummer")) %>%
  full_join(gr_data_long,       by = c("Jahr", "bezirksnummer"))

# 3.7 Mit Geometrie verknüpfen (sf)
final_sf_data_long <- munich_map %>%
  left_join(combined_data_all, by = c("sb_nummer" = "bezirksnummer")) %>%
  filter(!is.na(Jahr))

# 3.8 Globale Konstanten für Shiny
MAP_NAME_COLUMN <- "name" 
MIN_YEAR <- min(final_sf_data_long$Jahr, na.rm = TRUE)
MAX_YEAR <- max(final_sf_data_long$Jahr, na.rm = TRUE)

variable_choices <- c(
  "Muttererstgeburtsalter"                   = "age_mean",
  "Frauenbeschäftigung (%)"          = "anteil",
  "Haushalte mit Kindern (%)"        = "anteil_kinder",
  "Kinderbetreuung (%)"    = "anteil_betreuung",
  "Geburtenrate (%)"                        = "new_baby"
)

# Globale Min/Max für konsistente Farben
GLOBAL_MIN_AGE        <- min(final_sf_data_long$age_mean,          na.rm = TRUE); GLOBAL_MAX_AGE        <- max(final_sf_data_long$age_mean,          na.rm = TRUE)
GLOBAL_MIN_ANTEIL     <- min(final_sf_data_long$anteil,            na.rm = TRUE); GLOBAL_MAX_ANTEIL     <- max(final_sf_data_long$anteil,            na.rm = TRUE)
GLOBAL_MIN_KINDER     <- min(final_sf_data_long$anteil_kinder,     na.rm = TRUE); GLOBAL_MAX_KINDER     <- max(final_sf_data_long$anteil_kinder,     na.rm = TRUE)
GLOBAL_MIN_BETREUUNG  <- min(final_sf_data_long$anteil_betreuung,  na.rm = TRUE); GLOBAL_MAX_BETREUUNG  <- max(final_sf_data_long$anteil_betreuung,  na.rm = TRUE)
GLOBAL_MIN_BABY       <- min(final_sf_data_long$new_baby,          na.rm = TRUE); GLOBAL_MAX_BABY       <- max(final_sf_data_long$new_baby,          na.rm = TRUE)




# =================================================================
# Shiny-Scatter für Moderierenden Effekt: Daten vorbereiten
# =================================================================

# Bevölkerungsdaten (0–2 Jahre)
be_0bis2 <- be_sheet %>% 
  filter(
    Indikator == "Altersgruppen",
    Ausprägung == "bis 2 Jahre"
  ) %>%
  select(Indikator, Ausprägung, Jahr, Raumbezug, `Basiswert 1`) %>%
  rename(kinder_total = `Basiswert 1`)

# Kinderbetreuungsdaten (0–2 Jahre)
ki_0bis2 <- ki_sheet %>% 
  filter(
    Indikator == "Altersgruppen",
    Ausprägung == "bis 2 Jahre"
  ) %>% 
  select(Indikator, Ausprägung, Jahr, Raumbezug, `Basiswert 1`) %>%
  rename(kinder_betreut = `Basiswert 1`)

# Zusammenführen von Bevölkerung + betreuten Kindern
df_betreut <- left_join(
  be_0bis2, ki_0bis2,
  by = c("Jahr", "Raumbezug", "Indikator", "Ausprägung")
) %>%
  mutate(
    kinder_unbetreut   = kinder_total - kinder_betreut,
    anteil_unbetreut   = kinder_unbetreut / kinder_total * 100,
    anteil_betreut     = kinder_betreut / kinder_total * 100
  )

# Beschäftigungsdaten (Anteil weiblich)
df_emp <- ar_sheet %>%
  filter(
    Indikator == "Sozialversicherungspflichtig Beschäftigte - Anteil",
    Ausprägung == "weiblich"
  ) %>%
  mutate(
    Jahr = as.numeric(Jahr),
    emp_female_pct = 100 * `Basiswert 1` / `Basiswert 2`
  ) %>%
  select(Jahr, Raumbezug, emp_female_pct)

# Haushalte mit Kindern
df_households <- be_sheet %>%
  filter(
    Indikator == "Haushalte mit Kindern",
    Ausprägung == "insgesamt"
  ) %>%
  mutate(
    Jahr = as.numeric(Jahr),
    households_pct = 100 * `Basiswert 1` / `Basiswert 2`
  ) %>%
  select(Jahr, Raumbezug, households_pct)

# Merge Beschäftigte + Haushalte
df_merged <- df_emp %>%
  inner_join(df_households, by = c("Jahr", "Raumbezug"))

```

## Agenda

1.  Datenüberblick

2.  Datenanalyse

    -   Frauenbeschäftigung

    -   Zusammenhang

        -   Haushalte mit Kindern

        -   Kinderbetreuung

3.  Fazit - Limitation - Ausblick

## Agenda

1.  Datenüberblick

[2. Datenanalyse]{style="color:lightgray;"}

-   [Frauenbeschäftigung]{style="color:lightgray;"}
-   [Zusammenhang]{style="color:lightgray;"}
    -   [Haushalte mit Kindern]{style="color:lightgray;"}
    -   [Kinderbetreuung]{style="color:lightgray;"}

[3. Fazit - Limitation - Ausblick]{style="color:lightgray;"}

## 

![](images/clipboard-3386569485.png)

## Daten {.smaller}

```{=html}
<style>
.no-wrap td {
  white-space: nowrap;
}

/* 页脚样式 */
.data-footer {
  font-size: 0.8em;
  color: #555;
  margin-top: 1.5em;
  text-align: left;
}

</style>
```

```{r}
#| echo: false
#| results: asis

knitr::kable(table_datenaufbau_01, format = "html", table.attr = 'class="no-wrap"')
```

```{=html}
<div class="data-footer">
  Datenquellen: Datengartl'n Stadt München
</div>
```

## Agenda

[1. Datenüberblick]{style="color:lightgray;"}

2.  Datenanalyse

    -   Frauenbeschäftigung

    -   [Zusammenhang]{style="color:lightgray;"}

        -   [Haushalte mit Kindern]{style="color:lightgray;"}

        -   [Kinderbetreuung]{style="color:lightgray;"}

[3. Fazit - Limitation - Ausblick]{style="color:lightgray;"}

------------------------------------------------------------------------

## Frauenbeschäftigung

*(Anteil weiblicher sozialversicherungspflichtig Beschäftigter)*

<br> <br>

Weibliche Bevölkerung, die in einem Arbeitsverhältnis stehen und deren Einkommen der Pflicht zur Zahlung von Sozialversicherungsbeiträgen unterliegt

## Frauenbeschäftigung 2024

<br>

```{r}

#| echo: false
#| out-width: 100%
#| out-height: 650px
#| fig-align: center

leaflet_sv_durchschnitt


```

```{r}
#| context: server

# ---- Play / Pause 状态 ----
playing <- reactiveVal(FALSE)

# 点击按钮切换播放状态 + 修改按钮文字
observeEvent(input$play_pause, {
  if (playing()) {
    playing(FALSE)
    updateActionButton(session, "play_pause", label = "▶ Play")
  } else {
    playing(TRUE)
    updateActionButton(session, "play_pause", label = "⏸ Pause")
  }
})

# 自动推进年份（只有在 playing() == TRUE 时才会动）
observe({
  req(playing())                  # 如果没在播放，下面不执行
  invalidateLater(500, session)   # 播放速度：800ms 一步

  current   <- isolate(input$time_slider)
  next_year <- if (current >= MAX_YEAR) MIN_YEAR else current + 1L

  updateSliderInput(session, "time_slider", value = next_year)
})

# 1. Reaktive gefilterte Daten (immer aktuelles Jahr + gewählte Variable)
filtered_sf_data <- reactive({
  final_sf_data_long %>% 
    filter(Jahr == input$time_slider) %>%
    select(
      sb_nummer,
      !!sym(MAP_NAME_COLUMN),
      geometry,
      Value = !!sym(input$variable_select)
    )
})

# 2. Grundkarte (wird einmal initialisiert)
output$map_output <- renderLeaflet({
  leaflet(options = leafletOptions(minZoom = 10, maxZoom = 14)) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%   # 黑白底图
    setView(lng = 11.5761, lat = 48.1372, zoom = 10)
})

# 3. Karte bei Änderung von Slider / Variable neu einfärben
observe({
  current_sf <- filtered_sf_data()
  var_id     <- input$variable_select
  var_label  <- names(variable_choices)[variable_choices == var_id]
  
  # ---- Farbbereich & Einheit je nach Variable ----
  if (var_id == "age_mean") {
    # Mütteralter -> pink ("RdPu")
    c_min <- GLOBAL_MIN_AGE;       c_max <- GLOBAL_MAX_AGE
    unit  <- " Jahre";             dec   <- 2
    pal_name <- "RdPu"
    
  } else if (var_id == "anteil") {
    # Frauenbeschäftigung -> blau
    c_min <- GLOBAL_MIN_ANTEIL;    c_max <- GLOBAL_MAX_ANTEIL
    unit  <- " %";                 dec   <- 1
    pal_name <- "Blues"
    
  } else if (var_id == "anteil_kinder") {
    # Haushalte mit Kindern -> grün
    c_min <- GLOBAL_MIN_KINDER;    c_max <- GLOBAL_MAX_KINDER
    unit  <- " %";                 dec   <- 1
    pal_name <- "Greens"
    
  } else if (var_id == "anteil_betreuung") {
    # Kinderbetreuung -> violett
    c_min <- GLOBAL_MIN_BETREUUNG; c_max <- GLOBAL_MAX_BETREUUNG
    unit  <- " %";                 dec   <- 1
    pal_name <- "Purples"
    
  } else {
    # Geburtenrate -> rot (Werte klein,多几位小数)
    c_min <- GLOBAL_MIN_BABY;      c_max <- GLOBAL_MAX_BABY
    unit  <- "";                   dec   <- 4
    pal_name <- "Reds"
  }
  
  pal <- colorNumeric(palette = pal_name, domain = c(c_min, c_max))
  
  popup_content <- paste0(
    "<b>Stadtteil:</b> ", current_sf[[MAP_NAME_COLUMN]], "<br/>",
    "<b>", var_label, ":</b> ", round(current_sf$Value, dec), unit
  )
  
  leafletProxy("map_output", data = current_sf) %>%
    clearShapes() %>%
    clearControls() %>%
    addPolygons(
      fillColor = ~pal(Value),
      weight = 1.5,
      opacity = 1,
      color = "white",
      dashArray = "1",
      fillOpacity = 0.7,
      label = lapply(popup_content, HTML),
      highlightOptions = highlightOptions(
        weight = 3,
        color  = "#666",
        fillOpacity = 0.9,
        bringToFront = TRUE
      )
    ) %>%
    addLegend(
      pal      = pal,
      values   = c(c_min, c_max),
      opacity  = 0.7,
      title    = var_label,
      labFormat= labelFormat(suffix = unit, digits = dec),
      position = "bottomright"
    )
})

```

## Frauenbeschäftigung

```{r}
#| panel: sidebar
# 这里是 Shiny 的 UI 控件（侧边栏）
selectInput(
  "variable_select",
  "",
  choices  = variable_choices,
  selected = "anteil"    # 默认先看 Frauenbeschäftigung
)

sliderInput(
  "time_slider",
  "Jahr",
  min     = MIN_YEAR,
  max     = MAX_YEAR,
  value   = MAX_YEAR,
  step    = 1,
  sep     = "",
  animate = FALSE
)

actionButton(
  "play_pause",
  "▶ Play",
  width = "100%"
)
```

```{r}
#| panel: fill
# 主区域放地图
leafletOutput("map_output", height = "650px")
```

------------------------------------------------------------------------

## Agenda

[1. Datenüberblick]{style="color:lightgray;"}

2.  Datenanalyse

    -   [Frauenbeschäftigung]{style="color:lightgray;"}

    -   Zusammenhang

        -   Haushalte mit Kindern

        -   [Kinderbetreuung]{style="color:lightgray;"}

[3. Fazit - Limitation - Ausblick]{style="color:lightgray;"}

## Haushalte mit Kindern

<br> <br>

<br> Anteil der Privathaushalte <br> mit mindestens einem Kind bis 17 Jahre <br> (mit mindestens einer Hauptwohnsitzperson) <br> an allen Privathaushalten in Prozent

## Korrelation (gesamt)

```{r}
#| label: hmk_korr_gesamt_point_sw
#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_korr_gesamt_point_sw
```

## Korrelation (Stadtteile)

```{r}
#| label: hmk_korr_point_line_nach_stadtteile_color
#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_korr_point_line_nach_stadtteile_color
```

## Simpson's Paradox

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_simpson_stadtteile_kleiner_0

```

## Korrelation (gesamt)

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_korr_gesamt_point_sw
```

## Korrelation (Jahre)

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_korr_point_line_nach_jahr_color

```

## Agenda

[1. Datenüberblick]{style="color:lightgray;"}

2.  Datenanalyse

    -   [Frauenbeschäftigung]{style="color:lightgray;"}

    -   Zusammenhang

        -   [Haushalte mit Kindern]{style="color:lightgray;"}

        -   Kinderbetreuung

[3. Fazit - Limitation - Ausblick]{style="color:lightgray;"}

## Kinderbetreuung

<br><br><br>

::: {style="font-size:1.8rem;"}
$$
\text{Kinderbetreuung}
=
\dfrac{
  \hspace{0.6cm}\text{# Betreute Kinder (0–2 Jahre)}\hspace{0.6cm}
}{
  \hspace{0.6cm}\text{# Alle Kinder (0–2 Jahre)}\hspace{0.6cm}
}
\quad\times 100\%
$$
:::

------------------------------------------------------------------------

## Dual-Trend: Kinderbetreuung und Frauenbeschäftigung (2007–2024)

```{r}
#| label: ki-dual_trend
#| echo: false
#| fig-align: center
#| fig-width: 9
#| fig-height: 5
#| fig-dpi: 300
##| out.extra: 'style="margin-left:-60px;"'

range_left  <- range(ki_dual_trend$data$share_enrolled, na.rm = TRUE)
range_right <- range(ki_dual_trend$data$emp_women,       na.rm = TRUE)

scale_factor <- (range_left[2] - range_left[1]) / (range_right[2] - range_right[1])

ki_dual_trend
```

## Korrelation (gesamt)

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 7
#| fig-height: 4
#| fig-dpi: 300



ki_point_korr_gesamt_sw
```

## Korrelation (Stadtteile)

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 7
#| fig-height: 4
#| fig-dpi: 300



ki_simpson_sw
```


## Korrelation (Jahre)

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 7
#| fig-height: 4
#| fig-dpi: 300



ki_point_line_color
```


## Dual-Trend: Kinderbetreuung und Frauenbeschäftigung (2007–2024)

```{r}
#| echo: false
#| fig-align: center
#| fig-width: 9
#| fig-height: 5
#| fig-dpi: 300

ki_dual_trend
```


## Zusammenhang 2015

<br><br>

```{r}
#| echo: false
#| layout-ncol: 2
#| out.width: "100%"
#| fig-height: 8
#| fig-dpi: 300
#| fig-align: center

sv_map_2015
ki_map_2015
```

## Agenda

[1. Datenüberblick]{style="color:lightgray;"}

2.  Datenanalyse

    -   [Frauenbeschäftigung]{style="color:lightgray;"}

    -   Zusammenhang

        -   [Haushalte mit Kindern]{style="color:lightgray;"}

        -   [Kinderbetreuung]{style="color:lightgray;"}

[3. Fazit - Limitation - Ausblick]{style="color:lightgray;"}

## Korrelation (Jahre)

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

hmk_korr_point_line_nach_jahr_color

```

## Betreuungsbedingte Korrelation

<br>

-   **Gruppenaufteilung:**

    -   **Hohe Betreuung:** obere Drittel der Stadtteile mit der höchsten Kinderbetreuungsquote

    -   **Niedrige Betreuung:** untere Drittel der Stadtteile mit der niedrigsten Kinderbetreuungsquote

## Korrelation (gesamt) 2024

```{r}
#| label: m_effekt_01
#| echo: false
#| fig-align: center
#| fig-width: 9
#| fig-height: 5
#| fig-dpi: 300

m_effekt_01
```

## Betreuungsbedingte Korrelation 2024
<br>

```{r}
#| label: m_effekt_02
#| echo: false
#| fig-align: center
#| fig-width: 9
#| fig-height: 5
#| fig-dpi: 300

m_effekt_02
```

## Betreuungsbedingte Korrelation

<br>

```{r}
#| context: server

# ---- 只给「散点图 Shiny」用的 Play / Pause 状态 ----
playing_scatter <- reactiveVal(FALSE)

# 点击按钮切换播放状态 + 修改按钮文字（注意 ID：play_pause_scatter）
observeEvent(input$play_pause_scatter, {
  if (playing_scatter()) {
    playing_scatter(FALSE)
    updateActionButton(session, "play_pause_scatter", label = "▶ Play")
  } else {
    playing_scatter(TRUE)
    updateActionButton(session, "play_pause_scatter", label = "⏸ Pause")
  }
})

# 年份序列（防止不是连续整数）
year_seq <- sort(unique(df_merged$Jahr))
year_min <- min(year_seq, na.rm = TRUE)
year_max <- max(year_seq, na.rm = TRUE)

# 自动推进年份（只有在 playing_scatter() == TRUE 时才会动）
observe({
  invalidateLater(1200, session)   # 播放速度：800ms 一步
  req(playing_scatter())          # 没在播放就直接停在这里
  req(!is.null(input$year))       # 确保 slider 已经有值

  current <- isolate(input$year)
  idx <- match(current, year_seq)

  if (is.na(idx) || idx >= length(year_seq)) {
    next_year <- year_seq[1]
  } else {
    next_year <- year_seq[idx + 1L]
  }

  updateSliderInput(session, "year", value = next_year)
})

# Jahresdatensatz (abhängig vom Slider input$year)
df_year <- reactive({
  req(input$year)

  df_merged %>%
    filter(
      Jahr == input$year,
      Raumbezug != "Stadt München"   # Stadt München raus
    ) %>%
    inner_join(
      df_betreut %>%
        filter(Jahr == input$year) %>%
        select(Raumbezug, anteil_betreut),
      by = "Raumbezug"
    )
})

# Jahresdatensatz + Betreuungsgruppen
df_year_grouped <- reactive({
  d  <- df_year()

  qs <- quantile(
    d$anteil_betreut,
    probs = c(0, 1/3, 2/3, 1),
    na.rm = TRUE
  )

  d %>%
    mutate(
      betreuung_group = cut(
        anteil_betreut,
        breaks = qs,
        labels = c("Niedrig", "Mittel", "Hoch"),
        include.lowest = TRUE
      )
    )
})

# Farben für Linien & Punkte
farben <- c(
  "Gesamt"             = "black",
  "Hohe Betreuung"     = "#e66101",
  "Niedrige Betreuung" = "#fdb863"
)

# Plot-Ausgabe
output$plot <- renderPlot({

  df <- df_year_grouped()

  # Linien-Datensatz (3 Linien)
  df_lines <- bind_rows(
    df %>% mutate(gruppe = "Gesamt"),
    df %>% filter(betreuung_group == "Hoch")    %>% mutate(gruppe = "Hohe Betreuung"),
    df %>% filter(betreuung_group == "Niedrig") %>% mutate(gruppe = "Niedrige Betreuung")
  )

  # Punkte für Hoch + Niedrig (farbig)
  df_points_grouped <- df %>%
    filter(betreuung_group %in% c("Hoch", "Niedrig")) %>%
    mutate(
      gruppe = case_when(
        betreuung_group == "Hoch"    ~ "Hohe Betreuung",
        betreuung_group == "Niedrig" ~ "Niedrige Betreuung"
      )
    )

  # Punkte für Gesamt (grau)
  df_points_gesamt <- df %>%
    filter(betreuung_group == "Mittel" | is.na(betreuung_group)) %>%
    mutate(gruppe = "Gesamt")

  ggplot() +

    # Punkte: Gesamt (grau)
    geom_point(
      data  = df_points_gesamt,
      aes(x = emp_female_pct, y = households_pct),
      color = "grey50",
      alpha = 0.6
    ) +

    # Punkte: Hoch / Niedrig (farbig)
    geom_point(
      data  = df_points_grouped,
      aes(x = emp_female_pct, y = households_pct, color = gruppe),
      alpha = 0.8
    ) +

    # Regressionslinien
    geom_smooth(
      data  = df_lines,
      aes(x = emp_female_pct, y = households_pct, color = gruppe),
      method = "lm",
      se     = FALSE,
      linewidth   = 1.2
    ) +

    scale_color_manual(values = farben, name = "Linien:") +

    labs(
      x = "Frauenbeschäftigung (%)",
      y = "Haushalte mit Kindern (%)"
    ) +

    annotate(
      "text", x = -Inf, y = Inf,
      label = paste("Jahr:", input$year),
      hjust  = -0.1,
      vjust  =  1.5,
      size   =  5
    ) +

    theme_minimal(base_size = 14)

}, width = 1600, height = 900)
```

```{r}
#| panel: sidebar

sliderInput(
  "year",
  "Jahr:",
  min     = min(df_merged$Jahr),
  max     = max(df_merged$Jahr),
  value   = max(df_merged$Jahr),
  step    = 1,
  sep     = "",
  animate = FALSE
)

actionButton(
  "play_pause_scatter",
  "▶ Play",
  width = "100%"
)

```

```{r}
#| panel: fill

plotOutput("plot", height = "450px")

```

## Betreuungsbedarf 2024

<br>

```{r}

#| echo: false
#| out-width: 100%
#| out-height: 600px
#| fig-align: center

m_effekt_2.5

```

## Betreuungsbedarf 2024

<br>

::::: columns
::: column
```{r}
#| echo: false
#| out.width: "100%"
#| out.height: "400px"

m_effekt_04

```
:::

::: column
```{r}
#| echo: false
#| out.width: "100%"
#| out.height: "400px"

m_effekt_03

```
:::
:::::

## Agenda

[1. Datenüberblick]{style="color:lightgray;"}

[2. Datenanalyse]{style="color:lightgray;"}

-   [Frauenbeschäftigung]{style="color:lightgray;"}
-   [Zusammenhang]{style="color:lightgray;"}
    -   [Haushalte mit Kindern]{style="color:lightgray;"}
    -   [Kinderbetreuung]{style="color:lightgray;"}

<br> 3. Fazit - Limitation - Ausblick

## Fazit

::: {style="font-size:65%;"}
### Frauenbeschäftigung:

-   Zuwachs in allen Stadtteilen\
-   Zentrale Stadtteile höhere Anteil, periphere Stadtteile niedrigere Anteil


### Haushalte mit Kindern:

-   Nach Stadtteil: meistens positive Korrelation\
-   Nach Jahr: negative Korrelation, die sich über die Zeit verstärkt

### Kinderbetreuung:

-   Nach Stadtteil: stark positive Korrelation\
-   Nach Jahr: negative Korrelation\
-   Höhere Kinderbetreuung schwächt die negative Korrelation zwischen Frauenbeschäftigung und Haushalten mit Kindern
:::

## Limitation

::: {style="font-size:85%;"}
-   **Sozialversicherungspflichtige Beschäftigung:**\
    nicht alle Erwerbstätigen umfassen

-   **Altersgruppen nicht vollständig kompatibel:**\
    Nur 0–2 Jahre stimmen überein; andere Altersgruppen sind nicht vergleichbar

-   **Unterschiedliche Zeitabdeckung:**\
    Beschäftigungsdaten ab 2000, Kinderbetreuungsdaten erst ab 2007
:::

## Ausblick

::: {style="font-size:85%;"}
-   **Feinere Datenebene:**\
    konkret analysieren und bedingte Wahrscheinlichkeiten berechnen\
    (ob eine Frau in einem Haushalt mit Kind und erwerbstätig ist)

-   **Kinderbetreuung und Frauenbeschäftigung weiter untersuchen:**\
    Politische und zeitliche Effekte berücksichtigen (Mini-Job, Kita-Ausbau)

-   **Erhöhung der Stichprobengröße:**\
    Postleitzahlen statt Stadtteile
:::

## Anhang

#### Literatur

<br> § 7 SGB IV und § 2 SGB IV

## Anhang

Geburtenrate

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

geburtenrate_dual_trend

```

------------------------------------------------------------------------

Geburtenrate

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 21
#| fig-height: 13
#| fig-dpi: 300

geburtenrate_trend_nach_stadtteile

```

------------------------------------------------------------------------

Geburtenrate

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

geburtenrate_korr_nach_stadtteile

```

------------------------------------------------------------------------

Geburtenrate

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

geburtenrate_korr_trend_nach_jahr

```

------------------------------------------------------------------------

### Durchschnittsalter Mütter erstgebärend

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

mea_gesamt_sw

```

------------------------------------------------------------------------

### Durchschnittsalter Mütter erstgebärend

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

mea_korr_nach_stadtteilen_point

```

------------------------------------------------------------------------

### Durchschnittsalter Mütter erstgebärend

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

mea_korr_nach_stadtteilen_point_line

```

------------------------------------------------------------------------

### Durchschnittsalter Mütter erstgebärend

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

mea_korr_jahr_point

```

------------------------------------------------------------------------

### Durchschnittsalter Mütter erstgebärend

```{r}

#| echo: false
#| fig-align: center
#| fig-width: 16
#| fig-height: 9
#| fig-dpi: 300

mea_korr_jahr_point_line

```
